\begin{figure}[t]
\centering
% \begin{minipage}{0.49\linewidth}
\begin{mcode}
(*\putBefore*) :: (*\vstate*) -> (*\expr*) -> (*\expr*) -> (*\vstate*)
(*\putAfter*)  :: (*\vstate*) -> (*\expr*) -> (*\expr*) -> (*\vstate*)
(*\putRoot*)   :: (*\vstate*) -> (*\expr*) -> (*\vstate*)
(*\getRoot*)   :: (*\vstate*) -> (*\expr*) -> (*\expr*)
(*\getPath*)      :: (*\tr*) -> (*\expr*) -> [(*\expr*)]

(*\getSubterms*) :: (*\vstate*) -> (*\expr*) -> [((*\expr*),(*\ctx*))]
(*\applyCtx*)    :: (*\vstate*) -> (*\expr*) -> (*\ctx*) -> (*\expr*)

findApp    :: (*\vstate*) -> (*\expr*) -> Maybe ((*\expr*),(*\ctx*))
findValue  :: (*\vstate*) -> (*\expr*) -> (*\expr*)

data (*\cmd*) = (*\stepforwardc*) | (*\stepbackwardc*)
         | (*\jumpforwardc*) | (*\jumpbackwardc*)
         | (*\stepoverc*)    | (*\stepintoc*)
\end{mcode}
% data (*\ctx*)
\caption{Graph manipulation and traversal API.}
\label{fig:graph-api}
\end{figure}
% \end{minipage}
% \begin{minipage}{0.49\linewidth}
\begin{figure}[t]
\begin{mcode}
(*\findExpr*) :: (*\vstate*) -> (*\cmd*) -> (*\expr*) -> Maybe (*\expr*)
(*\findExpr*) v c e = case c of
  (*\stepforwardc*) -> 
    let p = (*\getPath*) v e in (p!!1)
  (*\stepbackwardc*) -> 
    let p = (*\getPath*) v ((*\getRoot*) v e) in last p
  (*\jumpforwardc*) -> case (*\findExpr*) v (*\stepforwardc*) e of
    $\eapp{v_1}{v_2}$ -> Just ($\eapp{v_1}{v_2}$)
    e'   -> (*\findExpr*) v c e'
  (*\jumpbackwardc*) -> case (*\findExpr*) v (*\stepbackwardc*) e of
    $\eapp{v_1}{v_2}$ -> Just ($\eapp{v_1}{v_2}$)
    e'   -> (*\findExpr*) v c e'
  (*\stepintoc*) -> findApp v e
  (*\stepoverc*) -> case findApp v e of
    Nothing       -> Nothing
    Just (e', cx) -> applyCtx v (crunch v e') cx

(*\updState*) :: (*\vstate*) -> (*\cmd*) -> (*\expr*) -> Maybe (*\vstate*)
(*\updState*) v c e = case (*\findExpr*) v c e of
  Nothing -> Nothing
  Just e' -> Just (*\$*) case c of
    (*\stepforwardc*) -> (*\putAfter\ v e e'*)
    (*\stepbackwardc*)    -> (*\putBefore\ v e e'*)
    (*\jumpforwardc*) -> (*\putAfter\ v e e'*)
    (*\jumpbackwardc*)    -> (*\putBefore\ v e e'*)
    (*\stepintoc*)    -> (*\putRoot\ v e' (crunch v e') *)
    (*\stepoverc*)    -> (*\putAfter\ v e e'*)
\end{mcode}
% \end{minipage}
% \[
% \begin{array}{lcl}
% \stepforward{G}{p}{e_i}  &\defeq& \left\{\begin{array}{ll}
%     e_j, & \text{where } \singlestep{e_i}{e_j} \in G
%                          \end{array}\right\} \\ \\
% \stepbackward{G}{p}{e_i}  &\defeq& \left\{\begin{array}{ll}
%     e_j, & \text{where } \singlestep{e_j}{e_i} \in G \text{ and } e_j \in p
%                          \end{array}\right\} \\ \\
% \jumpforward{G}{p}{e_i} &\defeq& \text{let } e_j = \stepforward{G}{p}{e_i} \text{ in }
%                          \left\{\begin{array}{ll}
%                          e_j, & \text{if } e_j = \eapp{v_1}{v_2} \\
%                          \jumpforward{G}{p}{e_{j}}, & \text{otherwise}
%                          \end{array}\right\} \\ \\
% \jumpbackward{G}{p}{e_i} &\defeq& \text{let } e_j = \stepbackward{G}{p}{e_i} \text{ in }
%                          \left\{\begin{array}{ll}
%                          e_j, & \text{if } e_j = \eapp{v_1}{v_2} \\
%                          \jumpbackward{G}{p}{e_{j}}, & \text{otherwise}
%                          \end{array}\right\} \\ \\
% \stepinto{G}{p}{e_i} &\defeq& \left\{\begin{array}{ll}
%                          e\sub{x}{v_2}, & \text{if } e_i = C[\eapp{v_1}{v_2}] \text{ and } \singlestep{\eapp{v_1}{v_2}}{e\sub{x}{v_2}}
%                          \end{array}\right\} \\ \\
% \stepover{G}{p}{e_i} &\defeq& \left\{\begin{array}{ll}
%                          C[v], & \text{if } e_i = C[\eapp{v_1}{v_2}] \text{ and } \multistep{\eapp{v_1}{v_2}}{v}
%                          \end{array}\right\}
% \end{array}
% \]
\caption{Rules for updating the reduction graph given a command and a selected expression. \texttt{updState} returns \texttt{Nothing} if the command was not applicable. % \stepintosym and \stepoversym require a traversal of the
  % sub-term edges to decompose $e_i$ into the target expression
  % \eapp{v_1}{v_2} and the context $C$.  \ES{these rules are quite ugly and waste space..}
}
\label{fig:traversing-graph}
\end{figure}
